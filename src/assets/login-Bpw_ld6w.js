var L=(y,p,s)=>new Promise(($,v)=>{var f=m=>{try{_(s.next(m))}catch(w){v(w)}},t=m=>{try{_(s.throw(m))}catch(w){v(w)}},_=m=>m.done?$(m.value):Promise.resolve(m.value).then(f,t);_((s=s.apply(y,p)).next())});import{A as S,E as k,s as se,u as D,c as ae,r as B,a as le,b as K,d as x,e as te,f as Z,g as ne,o as T,w as a,h as o,i as n,j,k as C,l as W,m as F,t as R,_ as re,n as ie,p as de,q as ue,v as pe,x as A,y as me,z as ce,B as P,C as fe,D as ge,F as O,G as we,H as I,I as he,J as _e}from"./index-DXV2JZ8m.js";import{E as J}from"./el-overlay-tl7whmgi.js";import{E as G,a as H}from"./el-form-item-B5fc7SOt.js";import{E as ve}from"./el-checkbox-CDMdhvJE.js";/* empty css                  */import"./index-CYGJEehB.js";import"./_Uint8Array-Bj4etxqr.js";import"./_initCloneObject-Dex4nZC8.js";const Ve=(y,p,s,$=!0)=>L(void 0,null,function*(){try{const v=yield S.postApi("/getPublicKey"),{res:f}=v,{result:t,publickey:_}=f;if(t!==1||!_){k.error("获取公钥失败!"),$&&z(y),s&&typeof s=="function"&&s();return}const m="04"+se.sm2.doEncrypt(JSON.stringify(y),_,0);return p&&typeof p=="function"&&p(m),m}catch(v){console.error("获取公钥或加密数据失败:",v),$&&z(y),s&&typeof s=="function"&&s(v)}}),z=y=>{var s;y.username&&D().setUserName(y.username);const p=ae[0].children[0];p?((s=p.children)==null?void 0:s.length)>0?B.push(p.path+"/"+p.children[0].path):B.push(p.path):console.error("无法找到默认路由!")},ye=["src"],be={__name:"ChangePwd",props:{visible:{type:Boolean,default:!1},visibleModifiers:{}},emits:["update:visible"],setup(y){const p=le(y,"visible"),{t:s}=K(),$=/^.*(?=.*\d)(?=.*[A-Z])(?=.*[a-z])(?=.*[!@#$%^&*?_]).*$/,v=(d,u,h)=>{$.test(u)?h():h(new Error(s("login.pwdFormatValidate")))},f=x(null),t=te({id:"",code:"",confirm:"",password:"",oldpassword:"",captcha_id:"",captcha_img:""}),_={id:[{required:!0,message:s("login.inputName"),trigger:"blur"}],oldpassword:[{required:!0,message:s("login.inputOldPwd"),trigger:"blur"},{min:8,max:16,message:s("login.lenValidate",{min:8,max:16}),trigger:"blur"}],password:[{required:!0,message:s("login.inputNewPwd"),trigger:"blur"},{min:8,max:16,message:s("login.lenValidate",{min:8,max:16}),trigger:"blur"},{validator:v,trigger:"blur"}],confirm:[{required:!0,message:s("login.confirmNewPwd"),trigger:"blur"},{min:8,max:16,message:s("login.lenValidate",{min:8,max:16}),trigger:"blur"},{validator:v,trigger:"blur"}],code:[{required:!0,message:s("login.inputCaptcha"),trigger:"blur"}]},m=()=>{p.value=!1},w=()=>{S.postApi("/getCaptcha").then(d=>{if(!d)return;const{captchaId:u,base64:h}=d.res;t.captcha_id=u,t.captcha_img=h})},i=()=>{f.value.validate(d=>L(this,null,function*(){d?Ve({user_id:t.id,password:t.oldpassword,newPassword:t.password,captcha:t.code,captcha_id:t.captcha_id,time:""},u=>{S.postApi("changePassword",u).then(h=>{var c;h.res.result>=0?(k.success(s("login.pwdChangeSuccess")),(c=f.value)==null||c.resetFields(),m()):k.error(s("login.pwdChangeFail"))})},()=>{w()}):console.error("表单校验不通过")}))},U=()=>{w()},M=()=>{var d;(d=f.value)==null||d.resetFields()};return(d,u)=>{const h=Z("SyIcon"),c=j,b=H,N=G,l=W,e=J;return T(),ne(e,{modelValue:p.value,"onUpdate:modelValue":u[5]||(u[5]=r=>p.value=r),title:d.$t("login.modifyPwd"),width:"30vw",size:"default",class:"change-pwd",onOpen:U,onClose:M},{footer:a(()=>[o(l,{onClick:m},{default:a(()=>[F(R(d.$t("login.cancel")),1)]),_:1}),o(l,{type:"primary",onClick:i},{default:a(()=>[F(R(d.$t("login.confirm")),1)]),_:1})]),default:a(()=>[o(N,{ref_key:"formRef",ref:f,class:"px-20px",model:n(t),rules:_},{default:a(()=>[o(b,{prop:"id"},{default:a(()=>[o(c,{modelValue:n(t).id,"onUpdate:modelValue":u[0]||(u[0]=r=>n(t).id=r),modelModifiers:{trim:!0},placeholder:d.$t("login.userName"),tabindex:"1"},{prefix:a(()=>[o(h,{name:"account",class:"prefix"})]),_:1},8,["modelValue","placeholder"])]),_:1}),o(b,{prop:"oldpassword"},{default:a(()=>[o(c,{modelValue:n(t).oldpassword,"onUpdate:modelValue":u[1]||(u[1]=r=>n(t).oldpassword=r),modelModifiers:{trim:!0},placeholder:d.$t("login.oldPwd"),type:"password",tabindex:"1","show-password":""},{prefix:a(()=>[o(h,{name:"password",class:"prefix"})]),_:1},8,["modelValue","placeholder"])]),_:1}),o(b,{prop:"password"},{default:a(()=>[o(c,{modelValue:n(t).password,"onUpdate:modelValue":u[2]||(u[2]=r=>n(t).password=r),modelModifiers:{trim:!0},placeholder:d.$t("login.newPwd"),type:"password",tabindex:"1","show-password":""},{prefix:a(()=>[o(h,{name:"password",class:"prefix"})]),_:1},8,["modelValue","placeholder"])]),_:1}),o(b,{prop:"confirm"},{default:a(()=>[o(c,{modelValue:n(t).confirm,"onUpdate:modelValue":u[3]||(u[3]=r=>n(t).confirm=r),modelModifiers:{trim:!0},placeholder:d.$t("login.confirmPwd"),type:"password",tabindex:"2","show-password":""},{prefix:a(()=>[o(h,{name:"password",class:"prefix"})]),_:1},8,["modelValue","placeholder"])]),_:1}),o(b,{prop:"code"},{default:a(()=>[o(c,{modelValue:n(t).code,"onUpdate:modelValue":u[4]||(u[4]=r=>n(t).code=r),name:"captcha_img",placeholder:d.$t("login.inputCaptcha"),maxlength:6},{suffix:a(()=>[C("img",{src:n(t).captcha_img,class:"w-100px h-40px cursor-pointer",alt:"验证码",onClick:w},null,8,ye)]),prefix:a(()=>[o(h,{name:"password",class:"prefix"})]),_:1},8,["modelValue","placeholder"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}},$e={class:"login-form-header"},xe={class:"login-form-header__logo"},Pe={class:"login-form-header__title"},Ce=["src"],Ee={class:"login-form-action"},Re=ie({name:"UserLogin"}),Ue=Object.assign(Re,{setup(y){const{t:p}=K(),s=de(),$=D(),v=x("Sieyuan"),f=x(""),t=x(!1),_=x(!1),m=x(null),w=x(!1),i=ue({username:"",password:"",vcode:"",captcha_id:""}),U=x(!1),M=pe(()=>{const l=(e,r,V)=>{U.value&&V();const E=/^(?![a-zA-Z]+$)(?![A-Z0-9]+$)(?![A-Z\W_]+$)(?![a-z0-9]+$)(?![a-z\W_]+$)(?![0-9\W_]+$)[a-zA-Z0-9#?!@$%^&*-._()]{8,30}$/;A(r)?!E.test(r)&&c.hasChange?V(new Error("密码格式错误")):V():V(new Error(p("login.inputPwd")))};return{username:[{required:!0,trigger:"change",message:p("login.inputName")}],password:[{required:!0,trigger:"change",validator:l}],vcode:[{required:!0,trigger:"change",message:p("login.inputCaptcha")}]}}),d=()=>L(this,null,function*(){const l=Object.keys(M.value);for(let e=0;e<l.length;e++)if(!(yield m.value.validateField(l[e])))return;m.value.validate(e=>{if(e){if(w.value=!0,!i.vcode){w.value=!1;return}const r=f.value&&A(c.password)&&!c.hasChange&&i.username===c.username?c.password:i.password;$.userLogin({username:i.username,password:r,captcha:i.vcode,captcha_id:i.captcha_id}).then(()=>{f.value?P.setLocal("userLogin",{username:i.username,password:r}):P.removeLocal("userLogin"),w.value=!1,s==null||s.push("/home").catch(()=>{b(!0)})}).catch(V=>{c.username!==i.username&&P.removeLocal("userLogin"),console.error("登录失败:",V),w.value=!1,b(!0)})}else w.value=!1})}),u=()=>{const l=P.getLocal("remomberPwd");A(l)?f.value=l:(f.value=!0,P.setLocal("remomberPwd",!0))},h=l=>{P.setLocal("remomberPwd",l)},c={username:"",password:"",hasChange:!1},b=l=>{l&&(i.captcha_id=""),S.getUserApi("captcha").then(e=>{if(!e)return;const{captcha:r,captcha_id:V}=e.data;i.captcha_id=V,i.captcha_img=r})},N=()=>{c.hasChange=!0};return me(()=>{b()}),ce(()=>L(this,null,function*(){u();const l=P.getLocal("userLogin");l&&(i.username=l.username,i.password="12345678",c.username=l.username,c.password=l.password)})),(l,e)=>{const r=Z("SyIcon"),V=j,E=H,q=W,Q=ve,X=G,Y=ge,ee=he,oe=J;return T(),fe(_e,null,[o(ee,{id:"user_login"},{default:a(()=>[o(Y,{class:"login-main"},{default:a(()=>[o(X,{key:"loginForm",ref_key:"loginFormRef",ref:m,class:"login-form",size:"large",model:n(i),rules:n(M),"label-position":"left"},{default:a(()=>[C("header",$e,[C("span",xe,R(n(v)),1),C("span",Pe,R(l.$t("login.title")),1)]),o(E,{prop:"username"},{default:a(()=>[o(V,{modelValue:n(i).username,"onUpdate:modelValue":e[0]||(e[0]=g=>n(i).username=g),modelModifiers:{trim:!0},placeholder:l.$t("login.inputName"),maxlength:20},{prefix:a(()=>[o(r,{name:"account",class:"prefix"})]),_:1},8,["modelValue","placeholder"])]),_:1}),o(E,{prop:"password"},{default:a(()=>[o(V,{modelValue:n(i).password,"onUpdate:modelValue":e[1]||(e[1]=g=>n(i).password=g),type:"password",placeholder:l.$t("login.inputPwd"),maxlength:30,"show-password":!0,onBlur:e[2]||(e[2]=g=>U.value=!1),onFocus:e[3]||(e[3]=g=>U.value=!0),onKeyup:O(d,["enter"]),onChange:e[4]||(e[4]=g=>N())},{prefix:a(()=>[o(r,{name:"password",class:"prefix"})]),_:1},8,["modelValue","placeholder"])]),_:1}),o(E,{prop:"vcode"},{default:a(()=>[o(V,{modelValue:n(i).vcode,"onUpdate:modelValue":e[5]||(e[5]=g=>n(i).vcode=g),placeholder:l.$t("login.inputCaptcha"),maxlength:6,onKeyup:O(d,["enter"])},{prefix:a(()=>[o(r,{name:"vcode",class:"prefix"})]),suffix:a(()=>[C("img",{class:"login-form-captcha w-100px h-40px cursor-pointer",src:n(i).captcha_img,onClick:b},null,8,Ce)]),_:1},8,["modelValue","placeholder"])]),_:1}),o(E,null,{default:a(()=>[o(q,{class:"login-form-button",type:"primary",loading:n(w),onClick:e[6]||(e[6]=we(g=>d(n(m)),["prevent"]))},{default:a(()=>[F(R(l.$t("login.login")),1)]),_:1},8,["loading"])]),_:1}),C("div",Ee,[o(Q,{modelValue:n(f),"onUpdate:modelValue":e[7]||(e[7]=g=>I(f)?f.value=g:null),label:l.$t("login.rememberPwd"),onChange:h},null,8,["modelValue","label"]),o(q,{link:"",onClick:e[8]||(e[8]=g=>_.value=!0)},{default:a(()=>[F(R(l.$t("login.modifyPwd")),1)]),_:1})])]),_:1},8,["model","rules"])]),_:1})]),_:1}),o(oe,{modelValue:n(t),"onUpdate:modelValue":e[9]||(e[9]=g=>I(t)?t.value=g:null),title:l.$t("login.version"),width:"40%"},{default:a(()=>e[11]||(e[11]=[C("li",null,"TROM-600A-MONITOR-R001-V1.02T5",-1)])),_:1,__:[11]},8,["modelValue","title"]),o(be,{visible:n(_),"onUpdate:visible":e[10]||(e[10]=g=>I(_)?_.value=g:null)},null,8,["visible"])],64)}}}),Be=re(Ue,[["__scopeId","data-v-3b2c45a8"]]);export{Be as default};
